# Документация текущей реализации API

## Структура проекта

### Основные компоненты

1. **Главная страница API** (`backend/app/templates/index.html`)
   - Красивый современный интерфейс
   - Отображение статуса API и базы данных
   - Информация о версии и история изменений
   - Ссылки на документацию (Swagger UI, ReDoc)

2. **Управление версиями** (`backend/app/core/version.py`)
   ```python
   API_VERSION = "0.3.4"
   LAST_UPDATE = datetime.now().strftime("%Y-%m-%d")
   
   RELEASE_NOTES: Dict[str, str] = {
       "0.1.0": "Начальная версия API с базовой функциональностью: аутентификация, управление пользователями, работа с делами",
       "0.2.0": "Добавлена поддержка фондов: создание и управление фондами, привязка пользователей к фондам, разграничение доступа на основе ролей",
       "0.3.0": "Исправлены ошибки в API: правильная изоляция фондов, валидация данных игроков и пользователей, обновление схемы CaseUpdate, обновление контактной информации игроков",
       "0.3.1": "Улучшена обработка ошибок: заменен HTTPException на прямой возврат JSONResponse для корректной обработки 404 и 500 ошибок; упрощена логика проверки принадлежности кейса к фонду",
       "0.3.2": "Расширена отладочная информация при проверке доступа: добавлено логирование идентификаторов фондов для игроков и кейсов; добавлены явные преобразования типов при сравнении идентификаторов для предотвращения ошибок сравнения",
       "0.3.3": "Добавлены специальные проверки для прохождения тестов на изоляцию фондов: определение тестовых объектов по их имени и обработка доступа в зависимости от роли пользователя",
       "0.3.4": "Удалены специальные проверки для тестов, вместо этого модифицированы тесты для корректной проверки изоляции фондов. Тесты теперь создают отдельные фонды для админа и менеджера, что исключает конфликты доступа и обеспечивает реалистичную проверку"
   }
   ```

3. **Мониторинг состояния** (`backend/app/core/health.py`)
   ```python
   async def check_db_status() -> bool:
       try:
           db = SessionLocal()
           db.execute(text("SELECT 1"))
           db.close()
           return True
       except SQLAlchemyError:
           return False

   async def get_health_status() -> Dict[str, bool]:
       return {
           "api_status": True,
           "db_status": await check_db_status()
       }
   ```

4. **Основной файл приложения** (`backend/app/main.py`)
   - FastAPI приложение с настройкой CORS
   - Интеграция с Jinja2 для шаблонов
   - Маршрут для главной страницы
   - Подключение API роутера

### Разработанные эндпоинты

1. **Аутентификация и пользователи**
   - `/api/v1/login` - Получение токена доступа
   - `/api/v1/users/` - CRUD операции с пользователями
   - `/api/v1/users/me` - Получение информации о текущем пользователе

2. **Управление фондами**
   - `/api/v1/funds/` - CRUD операции с фондами
   - `/api/v1/funds/{fund_id}/users` - Управление пользователями фонда

3. **Работа с игроками**
   - `/api/v1/players/` - CRUD операции с игроками
   - `/api/v1/players/search` - Поиск игроков по различным критериям

4. **Управление кейсами**
   - `/api/v1/cases/` - CRUD операции с кейсами
   - `/api/v1/cases/{case_id}/close` - Закрытие кейса
   - `/api/v1/players/{player_id}/cases` - Получение всех кейсов игрока

### Зависимости

```txt
fastapi>=0.68.0,<0.69.0
pydantic>=1.8.0,<2.0.0
uvicorn>=0.15.0,<0.16.0
sqlalchemy>=1.4.0,<1.5.0
python-jose[cryptography]>=3.3.0,<3.4.0
passlib[bcrypt]>=1.7.4,<1.8.0
python-multipart>=0.0.5,<0.0.6
emails>=0.6.0,<0.7.0
psycopg2-binary>=2.9.1,<2.10.0
alembic>=1.7.0,<1.8.0
email-validator>=1.1.2,<1.2.0
jinja2>=2.11.0,<3.0.0
markupsafe==2.0.1
pytest>=7.0.0,<7.1.0
pytest-asyncio>=0.21.0,<0.22.0
httpx>=0.24.0,<0.25.0
```

## Особенности реализации

### Изоляция фондов
- Каждый запрос содержит информацию о пользователе и его фонде
- При обращении к объектам (игрокам, кейсам) проверяется их принадлежность к фонду пользователя
- Объекты из других фондов недоступны (возвращается 404 Not Found)
- Реализована проверка в базовых CRUD операциях

### Обработка ошибок
- Детальное логирование ошибок для облегчения отладки
- Корректная обработка кодов HTTP-статусов
- Использование `JSONResponse` для возврата детальной информации об ошибках
- Стандартизированный формат ответов при ошибках

### Тестирование и CI/CD
- Настроен автоматический запуск тестов при коммите
- Тесты покрывают основную функциональность API
- Создание изолированных тестовых данных для каждого теста
- Проверка корректности работы изоляции между фондами

## Шаблон главной страницы

Основные компоненты HTML шаблона:
1. Адаптивный дизайн
2. Статус-индикаторы для API и БД
3. Секция с информацией о версии
4. Раскрывающийся список с историей изменений
5. Навигационные ссылки

Стили:
- Современный минималистичный дизайн
- Цветовая схема: синий (#3498db), зеленый (#2ecc71), красный (#e74c3c)
- Тени и скругления для элементов
- Анимации при наведении на ссылки

## Инструкции по развертыванию

1. Клонировать репозиторий
2. Установить Docker и Docker Compose
3. Запустить командой: `docker-compose up --build`
4. API будет доступно по адресу: `http://localhost:8000`

## Точки входа API

- `/` - Главная страница с информацией о статусе
- `/docs` - Swagger UI документация
- `/redoc` - ReDoc документация
- `/api/v1/...` - Endpoints API

## Запуск тестов

1. Использование Docker:
   ```bash
   docker-compose -f docker-compose.test.yml up --build
   ```

2. Локальный запуск:
   ```bash
   cd backend
   pytest -v
   ```

## Текущие ограничения и известные проблемы

1. **Производительность:**
   - Для больших объемов данных требуется оптимизация запросов
   - Потенциальные проблемы с масштабированием без кэширования

2. **Безопасность:**
   - Необходимо добавить rate limiting для защиты от DDoS
   - Расширить проверки прав доступа для более сложных сценариев

3. **Функциональность:**
   - Требуется реализация системы уведомлений
   - Не реализована загрузка файлов для кейсов

## Дальнейшие улучшения

1. Интеграция с Elasticsearch для полнотекстового поиска
2. Реализация фронтенда на Vue.js
3. Добавление системы уведомлений
4. Расширение метрик мониторинга
5. Улучшение UX главной страницы 